services:
  web:
    build: .
    container_name: mru_fx_web
    command: >
      sh -c "
      python manage.py makemigrations && python manage.py migrate &&
      python manage.py runserver 0.0.0.0:8000
      "
    ports:
      - "127.0.0.1:28000:8000"
    volumes:
      - ./mru_fx:/app

  fetcher:
    build: .
    container_name: mru_fx_scheduler
    depends_on:
      - web
    volumes:
      - ./mru_fx:/app
    environment:
      - DJANGO_SETTINGS_MODULE=mru_fx.settings
      - SQLITE_PATH=/app/db.sqlite3
      - BCM_API_BASE=https://connect.bcm.mr/api/cours_change_reference
      - BCM_LOOKBACK_DAYS=30
      - BCM_MAX_LOOKBACK_DAYS=365
    command: >
      sh -c "
      python manage.py migrate &&
      while true; do
        echo \"[scheduler] Fetching BCM rates at $(date -u)\";
        python manage.py fetch_rates --quotes USD EUR CNY || echo \"[scheduler] fetch_rates failed\";
        sleep 86400;
      done
      "
